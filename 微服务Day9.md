# 微服务Day9

## 微服务保护和分布式事务

### 一、雪崩问题

1.雪崩：微服务调用链路中的某个服务故障，引起整个链路中的所有微服务都不可用 

2.产生原因

微服务相互调用，服务提供者出现故障或阻塞；

服务调用者没有做好异常处理，导致自身故障；

调用链中的所有服务级联失败，导致整个集群故障

3.解决方法

（1）服务提供者：尽量避免服务出现故障或阻塞（保证代码的健壮性、保证网络畅通、能应对较高的并发请求等）

请求限流：限制访问微服务的请求的并发量，避免服务因流量激增出现故障

（2）服务调用者：服务调用者做好远程调用的后备方案，避免故障扩散

线程隔离：也叫做舱壁模式，模拟船舱隔板的防水原理，通过限定每个业务能使用的线程数量而将故障业务隔离，避免故障扩散

服务熔断：由断路器统计请求的异常比例或慢调用比例，如果超过阈值则会熔断该服务，拦截该接口的请求；熔断期间，所有请求快速失败，全都走fallback逻辑（fallback逻辑是一种备用逻辑，如果调用某个服务失败，则走这个备用逻辑，根据具体业务来写）

### 二、Sentinel

1.初识Sentinel

Sentinel是阿里巴巴开源的一款微服务流量控制组件

(1)Sentinel安装

搭建控制台：下载jar包-运行jar包-访问localhost:8090（jar包可以在飞书项目文档中下载）

导入依赖：在cart-service中引入sentinel依赖，然后修改application.yaml文件，添加sentinel控制台地址

重启服务：配置完成后重新启动cart-service服务，访问Sentinel控制台地址，同时打开项目前端页面调用一次购物车接口，就可以在Sentinel控制台中看到cart-service的监控页面了

（2）簇点链路

单击调用链路，是一次请求进入服务后经过的每一个被Sentinel监控的资源链，默认Sentinel会监控Spring MVC的每一个Endpoint（http接口），限流、熔断等都是针对簇点链路中的资源设置的，而资源名默认就是接口的请求路径（如/carts）

所以/carts这个接口路径就是一个簇点，可以对其采取限流、熔断、隔离等保护措施

注意：Restful风格的API请求路径一般都相同，而Sentinel会把路径作为簇点资源的名称，无法区分路径相同但请求方式不同的接口，查询、删除、修改等都会被识别为一个簇点资源，这显然不合适！

所以我们需要修改一下配置（修改cart-service的application文件），把请求方式+请求路径作为簇点资源名称；然后重启服务，此时会发现Sentinel控制台中的簇点链路已经可以按照请求类型来区分了

2.请求限流

在簇点链路后面点击流控按钮，即可对其做限流配置

QPS：每秒钟并发请求的数量

可以使用Jmeter进行测试（假如配置了单机QPS阈值为6，此时如果每秒钟有10个请求同时访问，就会有4个请求被拒绝，状态码为429）

