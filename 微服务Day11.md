# 微服务Day11

## 三、分布式事务 

1.分布式事务

以下单业务为例，前端请求首先进入订单服务，创建订单并写入数据库，然后订单服务调用购物车服务（清理购物车信息）和库存服务（扣减商品库存）

如果订单服务和购物车服务执行成功，而库存服务执行失败，即创建了订单并清空了购物车，但是库存扣减失败，此时如果想要回滚，购物车服务是无法感知到的（即购物车服务无法回滚）

概念：在分布式系统中，如果一个业务需要多个服务合作完成，而且每一个服务都有事务，多个事务必须同时成功或失败，这样的事务就是分布式事务，其中的每个服务的事务就是一个分支事务，整个业务称为全局事务

2.初识Seata

Seata是2019年1月由蚂蚁金服和阿里巴巴共同开源的分布式事务解决方案

（1）分布式事务解决思路

解决分布式事务，各个子事务之间必须能感知到彼此的事务状态，才能保证状态一致

创建一个事务协调者，各个服务汇报自己的事务完成情况，再由事务协调者确定是否需要回滚

（2）seata架构

TC（Transaction Coordinator）-事务协调者：维护全局和分支事务的状态，协调全局事务提交或回滚

TM（Transaction Manager）-事务管理器：定义全局事务的范围、开启全局事务、提交或回滚全局事务、结束全局事务

RM（Resource Manager）-资源管理器：管理分支事务，与TC交谈来注册分支事务和报告分支事务的状态

3.部署TC服务

（1）准备数据库表

执行课程资料中的seata-tc.sql，导入数据库表

（2）准备配置文件

课程资料中有一个seata目录，其中包括了seata运行时所需的全部配置文件（因为配置文件比较复杂，所以最好还是直接用这个配置文件，不要自己配～）

将准备好的seata压缩包上传到虚拟机的/root目录中（用云服务器也可以）

（3）Docker部署

注意：这里需要把nacos加入到hm-net网络中，如果已经存在就不需要加了

在虚拟机的/root目录执行课程文档中的命令（注意把SEATA_IP改为自己的虚拟机或云服务器的IP）

（4）在浏览器中访问Seata

部署完毕后，访问IP:7099端口即可进入Seata主页

4.微服务集成Seata

（1）引入Seata依赖

（2）在application.yaml中添加配置，让微服务找到TC服务地址（包括cart-service、item-service、trade-service）

定位服务的过程：命名空间-分组-服务名-具体集群-服务IP

在nacos中创建一个共享配置，命名为shared-seata.yaml，直接使用课程云文档中的配置

再改造application.yaml配置文件，同时在bootstrap.yaml配置文件中新增一个data-id，值为刚才创建的seata.yaml

配置完成后重启服务