# 微服务Day12

5.XA模式

XA规范是X/Open组织定义的分布式事务处理标准，描述了全局的TM与局部的RM之间的接口，几乎所有主流的关系型数据库都对XA规范提供了支持

 （1）XA模式工作原理

一阶段：

RM注册分支事务到TC；

RM执行分支业务sql但不提交；

RM报告执行状态到TC；

二阶段：

TC检测各分支事务执行状态，如果都成功则通知所有RM提交事务，如果有失败则通知所有RM回滚事务；

RM接收TC指令，提交或者回滚

（2）XA模式优缺点

优点：可以保证事务的强一致性，满足ACID原则；

常用数据库都支持，实现简单，并且没有代码侵入

缺点：因为一阶段需要锁定数据库资源，等待二阶段结束才释放，所以性能较差；

依赖关系型数据库实现事务

（3）实现XA模式

-修改application.yaml文件（每个参与事务的微服务），开启XA模式；

因为seata配置已经共享到了nacos中，所以可以直接到nacos里修改配置 

-给发起全局事务的入口方法添加@GlobalTransactional注解（课程中的例子是OrderServicelmpl中的create方法）

-重启服务并测试

6.AT模式

Seata主推的是AT模式，AT模式同样是分阶段提交的事务模型，但是弥补了XA模型中资源锁定周期过长的缺陷

（1）AT模式工作原理

-一阶段RM的工作：

注册分支事务；

记录undo-log（数据快照）；

执行业务sql并提交；

报告事务状态；

-二阶段提交时RM的工作：

删除undo-log即可；

-二阶段回滚时RM的工作：

根据undo-log恢复数据到更新前；

（2）AT模式优缺点

优点：sql执行完后直接提交，提升系统性能

缺点：因为在第一阶段出现的故障在第二阶段才会回滚，所以会出现短暂的数据不一致情况

（3）AT模式和XA模式的区别

-XA模式一阶段不提交事务，锁定资源；AT模式一阶段直接提交事务，不锁定资源

-XA模式依赖数据库机制实现回滚，AT模式利用数据快照实现数据回滚

-XA模式数据强一致，AT模式数据最终一致

（4）实现XA模式

首先将资料中的seata-at.sql添加到数据库中（每个微服务的数据库都需要添加），再修改application.yaml文件，将事务模式修改为XA模式

注意：undolog在使用完后会被删除，所以数据库里的undo_log表不会有数据；如果想看到undo_log的数据，可以在程序里打断点debug查看